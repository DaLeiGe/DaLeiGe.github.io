I"X»<meta name="referrer" content="no-referrer" />

<p>æœ¬æ–‡Okhttpæºç æ˜¯å¯¹ä»¥ä¸‹ç‰ˆæœ¬ï¼Œä»å¼€å§‹è¯·æ±‚åˆ°è¯·æ±‚ç»“æŸå›è°ƒè¯·æ±‚ç»“æœçš„è¿™ä¸ªä¸»è¦æµç¨‹</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre> implementation 'com.squareup.okhttp3:okhttp:3.10.0'
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ‰€æ¶‰åŠçš„æ ¸å¿ƒç±»ä¸º</p>
<ul>
  <li>OkhttpClient</li>
  <li>Request</li>
  <li>Response</li>
  <li>Call</li>
  <li>Callback</li>
</ul>

<h3 id="okhttpç®€å•ä½¿ç”¨å¦‚ä¸‹">Okhttpç®€å•ä½¿ç”¨å¦‚ä¸‹</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> --><td class="rouge-code"><pre><span class="nc">OkHttpClient</span> <span class="n">okHttpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">"http://baidu.com"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">get</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="n">okHttpClient</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="n">call</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">Callback</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">Call</span> <span class="n">call</span><span class="o">,</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="s">"fail ---"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="o">(</span><span class="nc">Call</span> <span class="n">call</span><span class="o">,</span> <span class="nc">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"test"</span><span class="o">,</span> <span class="s">"success--&gt;"</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="å‘é€è¯·æ±‚çš„ä¸»çº¿æµç¨‹">å‘é€è¯·æ±‚çš„ä¸»çº¿æµç¨‹</h3>
<p>call.enqueue(Callback responseCallback)ï¼Œcallæ˜¯ä¸€ä¸ªæ¥å£å®ƒçš„å®ç°ç±»æ˜¯RealCall</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> --><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">RealCall</span> <span class="kd">implements</span> <span class="nc">Call</span> <span class="o">{</span>

    <span class="o">...</span>
  <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">Callback</span> <span class="n">responseCallback</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">executed</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="s">"Already Executed"</span><span class="o">);</span>
      <span class="n">executed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">captureCallStackTrace</span><span class="o">();</span>
    <span class="n">eventListener</span><span class="o">.</span><span class="na">callStart</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">client</span><span class="o">.</span><span class="na">dispatcher</span><span class="o">().</span><span class="na">enqueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">AsyncCall</span><span class="o">(</span><span class="n">responseCallback</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="o">...</span>

<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>ä»¥ä¸Šè¿™æ®µä»£ç è¡¨ç¤ºä¸èƒ½åŒæ—¶æ‰§è¡Œç›¸åŒçš„è¯·æ±‚ï¼Œå¦åˆ™ä¼šæŠ›å‡ºâ€Already Executedâ€çš„å¼‚å¸¸ï¼Œç„¶åæ‰§è¡Œåˆ°client.dispatcher().enqueue(new AsyncCall(responseCallback))ï¼Œè·Ÿè¿›Dispatcherä¸­</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td> --><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Dispatcher</span> <span class="o">{</span>
  <span class="c1">//ç­‰å¾…é˜Ÿåˆ—çš„å®¹é‡</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxRequests</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>
  <span class="c1">//è¿è¡Œé˜Ÿåˆ—çš„å®¹é‡</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxRequestsPerHost</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
  <span class="c1">//è¯·æ±‚çš„ç¼“å­˜é˜Ÿåˆ—</span>
  <span class="kd">private</span> <span class="nd">@Nullable</span> <span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">;</span>
  <span class="c1">//ç­‰å¾…é˜Ÿåˆ—</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Deque</span><span class="o">&lt;</span><span class="nc">AsyncCall</span><span class="o">&gt;</span> <span class="n">readyAsyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayDeque</span><span class="o">&lt;&gt;();</span>
  <span class="c1">//å¼‚æ­¥è¯·æ±‚çš„è¿è¡Œé˜Ÿåˆ—</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Deque</span><span class="o">&lt;</span><span class="nc">AsyncCall</span><span class="o">&gt;</span> <span class="n">runningAsyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayDeque</span><span class="o">&lt;&gt;();</span>
  <span class="c1">//åŒæ­¥è¯·æ±‚çš„è¿è¡Œé˜Ÿåˆ—</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Deque</span><span class="o">&lt;</span><span class="nc">RealCall</span><span class="o">&gt;</span> <span class="n">runningSyncCalls</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayDeque</span><span class="o">&lt;&gt;();</span>

  <span class="c1">//åˆå§‹åŒ–ç¼“å­˜é˜Ÿåˆ—</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">ExecutorService</span> <span class="nf">executorService</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">executorService</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">executorService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="mi">60</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
          <span class="k">new</span> <span class="nc">SynchronousQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;(),</span> <span class="nc">Util</span><span class="o">.</span><span class="na">threadFactory</span><span class="o">(</span><span class="s">"OkHttp Dispatcher"</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">executorService</span><span class="o">;</span>
  <span class="o">}</span>

    <span class="c1">//å¼‚æ­¥è¯·æ±‚</span>
  <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="nc">AsyncCall</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//å¦‚æœå¯¹åŒä¸€ä¸ªhoståœ°å€è¯·æ±‚çš„çš„è¿è¡Œé˜Ÿåˆ—æ­¤æ—¶é•¿åº¦å°äº5ï¼Œåˆ™æŠŠè¯·æ±‚æ·»åŠ è¿›è¿è¡Œé˜Ÿåˆ—ï¼Œç«‹å³é€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œï¼Œå¦‚æœä¸æ»¡è¶³æ¡çº¿å°±å…ˆæ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œ</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">maxRequests</span> <span class="o">&amp;&amp;</span> <span class="n">runningCallsForHost</span><span class="o">(</span><span class="n">call</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">maxRequestsPerHost</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">runningAsyncCalls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
      <span class="n">executorService</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="n">readyAsyncCalls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">call</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>Dispatcherç±»ä¸­å®šä¹‰äº†ç­‰å¾…é˜Ÿåˆ—å’ŒåŒæ­¥è¯·æ±‚å’Œå¼‚æ­¥è¯·æ±‚çš„é˜Ÿåˆ—ï¼Œä»¥åŠç­‰å¾…åˆ—è¡¨å®¹é‡64ï¼Œè¿è¡Œé˜Ÿåˆ—é•¿åº¦5ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ·»åŠ ä¸€ä¸ªè¯·æ±‚æ­¤æ—¶è¿è¡Œé˜Ÿåˆ—é‡Œé¢ä¸è¶³5ä¸ªå°±ç›´æ¥æŠŠè¿™ä¸ªè¯·æ±‚æ”¾è¿›è¿è¡Œé˜Ÿåˆ—ç›´æ¥æ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰äº”ä¸ªåˆ™å…ˆæ”¾åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰è¿è¡Œé˜Ÿåˆ—é‡Œé¢æ‰§è¡Œå®Œå°‘äº5ä¸ªçš„æ—¶å€™å†ä»ç­‰å¾…é˜Ÿåˆ—é‡Œé¢å–å»æ”¾å…¥è¿è¡Œé˜Ÿåˆ—æ‰§è¡Œè¯·æ±‚
å…¶ä¸­çº¿ç¨‹æ± åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> --><td class="rouge-code"><pre> <span class="n">executorService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> 
                    <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> 
                    <span class="mi">60</span><span class="o">,</span>
                    <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
                    <span class="k">new</span> <span class="nc">SynchronousQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;(),</span> 
                    <span class="nc">Util</span><span class="o">.</span><span class="na">threadFactory</span><span class="o">(</span><span class="s">"OkHttp Dispatcher"</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
  
 <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Util</span><span class="o">{</span>
     <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ThreadFactory</span> <span class="nf">threadFactory</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">daemon</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadFactory</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="n">daemon</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">};</span>
 <span class="o">}</span> 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åˆ›å»ºäº†ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ä¸º0ï¼Œæ— é™å®¹é‡çš„å­çº¿ç¨‹ï¼Œå­˜æ´»æ—¶é—´60sçš„çº¿ç¨‹æ± ï¼Œå¹¶ä¸”ä¸ºçº¿ç¨‹æŒ‡å®šäº†åå­—ï¼Œthread.setDaemon(daemon)è®¾ç½®çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ŒSynchronousQueueæ˜¯ä¸€ä¸ªæ²¡æœ‰å®¹é‡çš„é˜Ÿåˆ—ï¼Œè¿™é‡Œé…åˆæ ¸å¿ƒçº¿ç¨‹ä¸º0ï¼Œçº¿ç¨‹å®¹é‡Int.Maxå®ç°äº†ä¸€ä¸ªæ¥æ”¶åˆ°è¯·æ±‚å°±ç›´æ¥åˆ†é…çº¿ç¨‹ï¼ˆå¤ç”¨æˆ–è€…æ–°åˆ›å»ºçº¿ç¨‹ï¼‰æ‰§è¡Œçš„è¿‡ç¨‹ã€‚
å†åˆ†æçº¿ç¨‹æ± æ‰§è¡ŒexecutorService().execute(call)ï¼Œå…¶ä¸­çš„callæ˜¯new AsyncCall(responseCallback)åˆ›å»ºçš„ï¼ŒAsyncCallsç»§æ‰¿è‡ªNamedRunnableï¼Œæ˜¯RealCallçš„å†…éƒ¨ç±»ã€‚NamedRunnableå®ç°äº†Runnableæ¥å£</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td> --><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">NamedRunnable</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
  <span class="kd">protected</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">NamedRunnable</span><span class="o">(</span><span class="nc">String</span> <span class="n">format</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="nc">Util</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">format</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">oldName</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">execute</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setName</span><span class="o">(</span><span class="n">oldName</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">();</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>AsyncCallç»§æ‰¿NamedRunnableï¼Œå¹¶ä¸”å®ç°äº†æŠ½è±¡æ–¹æ³•execute</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td> --><td class="rouge-code"><pre><span class="kd">final</span> <span class="kd">class</span> <span class="nc">RealCall</span> <span class="kd">implements</span> <span class="nc">Call</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="kd">class</span> <span class="nc">AsyncCall</span> <span class="kd">extends</span> <span class="nc">NamedRunnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Callback</span> <span class="n">responseCallback</span><span class="o">;</span>

    <span class="nc">AsyncCall</span><span class="o">(</span><span class="nc">Callback</span> <span class="n">responseCallback</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="s">"OkHttp %s"</span><span class="o">,</span> <span class="n">redactedUrl</span><span class="o">());</span>
      <span class="k">this</span><span class="o">.</span><span class="na">responseCallback</span> <span class="o">=</span> <span class="n">responseCallback</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">String</span> <span class="nf">host</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">originalRequest</span><span class="o">.</span><span class="na">url</span><span class="o">().</span><span class="na">host</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nc">Request</span> <span class="nf">request</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">originalRequest</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">RealCall</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//å®ç°çˆ¶ç±»å®šä¹‰çš„æŠ½è±¡ç±»ï¼Œå½“çˆ¶ç±»è¢«çº¿ç¨‹æ± æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿™ä¸ªç±»ä¹Ÿä¼šæ‰§è¡Œ</span>
    <span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">boolean</span> <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//è´£ä»»é“¾æ¨¡å¼å®ç°çš„å„ç±»æ‹¦æˆªå™¨</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">getResponseWithInterceptorChain</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">retryAndFollowUpInterceptor</span><span class="o">.</span><span class="na">isCanceled</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="n">responseCallback</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IOException</span><span class="o">(</span><span class="s">"Canceled"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="n">responseCallback</span><span class="o">.</span><span class="na">onResponse</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">signalledCallback</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Do not signal the callback twice!</span>
          <span class="nc">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">log</span><span class="o">(</span><span class="no">INFO</span><span class="o">,</span> <span class="s">"Callback failure for "</span> <span class="o">+</span> <span class="n">toLoggableString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">eventListener</span><span class="o">.</span><span class="na">callFailed</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
          <span class="n">responseCallback</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">client</span><span class="o">.</span><span class="na">dispatcher</span><span class="o">().</span><span class="na">finished</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>é€šè¿‡ä»¥ä¸Šè¿‡ç¨‹å¯ä»¥çŸ¥é“ï¼Œå½“Dispatcher.enqueue()æ‰§è¡Œçº¿ç¨‹æ± executorService().execute(call)ä¼šè§¦å‘RealCallçš„å†…éƒ¨ç±»AsyncCallæ‰§è¡Œå¤å†™çˆ¶ç±»æŠ½è±¡çš„executeæ–¹æ³•</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td> --><td class="rouge-code"><pre><span class="nd">@Override</span> <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">boolean</span> <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">getResponseWithInterceptorChain</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">retryAndFollowUpInterceptor</span><span class="o">.</span><span class="na">isCanceled</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="n">responseCallback</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="k">new</span> <span class="nc">IOException</span><span class="o">(</span><span class="s">"Canceled"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">signalledCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="n">responseCallback</span><span class="o">.</span><span class="na">onResponse</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">signalledCallback</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// Do not signal the callback twice!</span>
          <span class="nc">Platform</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">log</span><span class="o">(</span><span class="no">INFO</span><span class="o">,</span> <span class="s">"Callback failure for "</span> <span class="o">+</span> <span class="n">toLoggableString</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">eventListener</span><span class="o">.</span><span class="na">callFailed</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
          <span class="n">responseCallback</span><span class="o">.</span><span class="na">onFailure</span><span class="o">(</span><span class="nc">RealCall</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">client</span><span class="o">.</span><span class="na">dispatcher</span><span class="o">().</span><span class="na">finished</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>é€šè¿‡ç­–ç•¥æ¨¡å¼é€å±‚è®©æ‹¦æˆªå™¨å¤„ç†responseï¼Œå¦‚æœè¯·æ±‚å¤±è´¥åˆ™å›è°ƒresponseCallback.onFailure(RealCall.this, new IOException(â€œCanceledâ€))ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸåˆ™å›è°ƒresponseCallback.onResponse(RealCall.this, response)ã€‚</p>

<p>å¦‚ä¸Šï¼ŒHttpè¯·æ±‚çš„ä¸»çº¿æµç¨‹å°±å®Œæˆäº†ã€‚</p>
<h3 id="okhttpä¸­ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼">Okhttpä¸­ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼</h3>
<h4 id="æ„å»ºè€…æ¨¡å¼">æ„å»ºè€…æ¨¡å¼</h4>
<p>OkHttpClientå’ŒRequestçš„åˆ›å»ºæ˜¯æ„é€ è€…æ¨¡å¼åˆ›å»ºçš„ï¼Œæ„é€ è€…æ¨¡å¼æ¯”è¾ƒå¸¸è§ä¸å¤šè§£é‡Šã€‚</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre><span class="nc">OkHttpClient</span> <span class="n">okHttpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
 <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
           <span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">"http://baidu.com"</span><span class="o">)</span>
           <span class="o">.</span><span class="na">get</span><span class="o">()</span>
           <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="è´£ä»»é“¾æ¨¡å¼">è´£ä»»é“¾æ¨¡å¼</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td> --><td class="rouge-code"><pre><span class="nc">Response</span> <span class="nf">getResponseWithInterceptorChain</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">// Build a full stack of interceptors.</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Interceptor</span><span class="o">&gt;</span> <span class="n">interceptors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">interceptors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">interceptors</span><span class="o">());</span>
    <span class="n">interceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">retryAndFollowUpInterceptor</span><span class="o">);</span>
    <span class="n">interceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BridgeInterceptor</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">cookieJar</span><span class="o">()));</span>
    <span class="n">interceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">CacheInterceptor</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">internalCache</span><span class="o">()));</span>
    <span class="n">interceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConnectInterceptor</span><span class="o">(</span><span class="n">client</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">forWebSocket</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">interceptors</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">networkInterceptors</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">interceptors</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">CallServerInterceptor</span><span class="o">(</span><span class="n">forWebSocket</span><span class="o">));</span>

    <span class="nc">Interceptor</span><span class="o">.</span><span class="na">Chain</span> <span class="n">chain</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RealInterceptorChain</span><span class="o">(</span><span class="n">interceptors</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
        <span class="n">originalRequest</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">eventListener</span><span class="o">,</span> <span class="n">client</span><span class="o">.</span><span class="na">connectTimeoutMillis</span><span class="o">(),</span>
        <span class="n">client</span><span class="o">.</span><span class="na">readTimeoutMillis</span><span class="o">(),</span> <span class="n">client</span><span class="o">.</span><span class="na">writeTimeoutMillis</span><span class="o">());</span>

    <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">originalRequest</span><span class="o">);</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>è´£ä»»é“¾æ¨¡å¼ï¼šä¸ºè¯·æ±‚åˆ›å»ºäº†ä¸€ä¸ªæ¥æ”¶è€…å¯¹è±¡çš„é“¾ã€‚è¿™ç§æ¨¡å¼ç»™äºˆè¯·æ±‚çš„ç±»å‹ï¼Œå¯¹è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…è¿›è¡Œè§£è€¦ã€‚è¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºè¡Œä¸ºå‹æ¨¡å¼ã€‚
åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œé€šå¸¸æ¯ä¸ªæ¥æ”¶è€…éƒ½åŒ…å«å¯¹å¦ä¸€ä¸ªæ¥æ”¶è€…çš„å¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤„ç†è¯¥è¯·æ±‚ï¼Œé‚£ä¹ˆå®ƒä¼šæŠŠç›¸åŒçš„è¯·æ±‚ä¼ ç»™ä¸‹ä¸€ä¸ªæ¥æ”¶è€…ï¼Œä¾æ­¤ç±»æ¨ã€‚</p>

<p>ä¸¾ä¸ªæ —å­ï¼š
å‘˜å·¥æåéœ€è¦è¯·å‡ï¼Œå‘æ‰€åœ¨éƒ¨é—¨ä¸»ç®¡(Manager1)ç”³è¯·ï¼Œéƒ¨é—¨ä¸»ç®¡(Manager1)åŒæ„è½¬ç»™ä¸Šä¸€çº§ä¸»ç®¡(Manager2)å®¡æ‰¹ï¼ŒManager2åŒæ„å®¡æ‰¹å†è½¬ç»™äººäº‹ä¸»ç®¡(Manager3)å®¡æ‰¹
step 1ï¼šåˆ›å»ºæ‰§è¡Œäº‹åŠ¡çš„æ¥å£IBaseTask.java</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> --><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">IBaseTask</span> <span class="o">{</span>
    <span class="cm">/**
     * @param task      äº‹åŠ¡å†…å®¹
     * @param iBaseTask ä¸‹ä¸€ä¸ªä»»åŠ¡èŠ‚ç‚¹
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAction</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">,</span> <span class="nc">IBaseTask</span> <span class="n">iBaseTask</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>äº‹ç‰¹æ‰¹ï¼šåˆ›å»ºä¸‰ä¸ªè´£ä»»é“¾æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ä¸‰ä¸ªç»ç†Manager</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td> --><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">Manager1</span> <span class="kd">implements</span> <span class="nc">IBaseTask</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAction</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">,</span> <span class="nc">IBaseTask</span> <span class="n">iBaseTask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"è¯·å‡"</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Manager1 åŒæ„è¯·å‡ å¹¶è½¬äº¤ç»™ä¸‹ä¸€ä¸ªManagerå®¡æ‰¹..."</span><span class="o">);</span>
            <span class="n">iBaseTask</span><span class="o">.</span><span class="na">doAction</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">iBaseTask</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Manager2</span> <span class="kd">implements</span> <span class="nc">IBaseTask</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAction</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">,</span> <span class="nc">IBaseTask</span> <span class="n">iBaseTask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"è¯·å‡"</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Manager2 åŒæ„è¯·å‡ å¹¶è½¬äº¤ç»™ä¸‹ä¸€ä¸ªManagerå®¡æ‰¹..."</span><span class="o">);</span>
            <span class="n">iBaseTask</span><span class="o">.</span><span class="na">doAction</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">iBaseTask</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Manager3</span> <span class="kd">implements</span> <span class="nc">IBaseTask</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAction</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">,</span> <span class="nc">IBaseTask</span> <span class="n">iBaseTask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"è¯·å‡"</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Manager3 åŒæ„è¯·å‡ æµç¨‹ç»“æŸ"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>step3ï¼šé€šè¿‡TaskManagerå®ç°è´£ä»»é“¾å®ç°</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td> --><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">TaskManager</span> <span class="kd">implements</span> <span class="nc">IBaseTask</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">IBaseTask</span><span class="o">&gt;</span> <span class="n">taskList</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">TaskManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">taskList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addTask</span><span class="o">(</span><span class="nc">IBaseTask</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">taskList</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">taskList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">taskList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="o">}</span>
        <span class="n">taskList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAction</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">,</span> <span class="nc">IBaseTask</span> <span class="n">iBaseTask</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">taskList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"taskList is empty!"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">taskList</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"index out of bundle!"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">IBaseTask</span> <span class="n">task</span> <span class="o">=</span> <span class="n">taskList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="n">index</span><span class="o">++;</span>
        <span class="n">task</span><span class="o">.</span><span class="na">doAction</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">iBaseTask</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æµ‹è¯•ç»“æœ</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> --><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TaskManager</span> <span class="n">taskManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TaskManager</span><span class="o">();</span>
        <span class="n">taskManager</span><span class="o">.</span><span class="na">addTask</span><span class="o">(</span><span class="k">new</span> <span class="nc">Manager1</span><span class="o">());</span>
        <span class="n">taskManager</span><span class="o">.</span><span class="na">addTask</span><span class="o">(</span><span class="k">new</span> <span class="nc">Manager2</span><span class="o">());</span>
        <span class="n">taskManager</span><span class="o">.</span><span class="na">addTask</span><span class="o">(</span><span class="k">new</span> <span class="nc">Manager3</span><span class="o">());</span>
        <span class="n">taskManager</span><span class="o">.</span><span class="na">doAction</span><span class="o">(</span><span class="s">"è¯·å‡"</span><span class="o">,</span> <span class="n">taskManager</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p>
<pre><code class="language-txt">Manager1 åŒæ„è¯·å‡ å¹¶è½¬äº¤ç»™ä¸‹ä¸€ä¸ªManagerå®¡æ‰¹...
Manager2 åŒæ„è¯·å‡ å¹¶è½¬äº¤ç»™ä¸‹ä¸€ä¸ªManagerå®¡æ‰¹...
Manager3 åŒæ„è¯·å‡ æµç¨‹ç»“æŸ
Class transformation time: 0.008817664s for 99 classes or 8.817664E-5s per class
</code></pre>
<p>Okhttpçš„æ‹¦æˆªå™¨ä¹Ÿæ˜¯ç±»ä¼¼å¦‚ä¸Šçš„è¿™ç§è´£ä»»é“¾æ¨¡å¼å®ç°ã€‚</p>

:ET